{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SmartPlaylist Pattern Config",
  "description": "Top-level configuration file that maps podcasts to smart playlist definitions. Contains a version number and an array of pattern configs.",
  "type": "object",
  "required": [
    "version",
    "patterns"
  ],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "integer",
      "const": 1,
      "description": "Schema version number. Must be 1."
    },
    "patterns": {
      "type": "array",
      "description": "Array of pattern configs, each matching a podcast and defining its smart playlists.",
      "items": {
        "$ref": "#/$defs/SmartPlaylistPatternConfig"
      }
    }
  },
  "$defs": {
    "SmartPlaylistPatternConfig": {
      "type": "object",
      "description": "Matches a podcast by GUID or feed URLs and provides playlist definitions.",
      "required": [
        "id",
        "playlists"
      ],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this pattern config."
        },
        "podcastGuid": {
          "type": "string",
          "description": "Podcast GUID for exact matching. Checked before feedUrls."
        },
        "feedUrls": {
          "type": "array",
          "description": "Exact feed URLs for matching.",
          "items": {
            "type": "string"
          }
        },
        "yearGroupedEpisodes": {
          "type": "boolean",
          "default": false,
          "description": "Whether the all-episodes view groups by year."
        },
        "playlists": {
          "type": "array",
          "description": "Playlist definitions for this podcast.",
          "items": {
            "$ref": "#/$defs/SmartPlaylistDefinition"
          },
          "minItems": 1
        }
      }
    },
    "SmartPlaylistDefinition": {
      "type": "object",
      "description": "Defines a single smart playlist with resolver type, filters, groups, and display options.",
      "required": [
        "id",
        "displayName",
        "resolverType"
      ],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this playlist definition."
        },
        "displayName": {
          "type": "string",
          "description": "Human-readable name for display."
        },
        "resolverType": {
          "description": "Type of resolver to use for episode grouping.",
          "oneOf": [
            {
              "const": "rss",
              "description": "RSS Metadata: Groups episodes by their season number from RSS feed metadata (e.g., itunes:season). Best for podcasts that properly tag seasons in their feed."
            },
            {
              "const": "category",
              "description": "Category: Groups episodes by matching their titles against regex patterns defined in the \"groups\" section. Use when episodes follow naming conventions like \"Arc 1: ...\" or \"Mystery Series: ...\"."
            },
            {
              "const": "year",
              "description": "Year: Groups episodes by their publication year. Good for long-running podcasts where yearly grouping is a natural fit."
            },
            {
              "const": "titleAppearanceOrder",
              "description": "Title Appearance Order: Groups episodes by a recurring pattern in their titles, ordered by when each pattern first appears in the feed. Useful for podcasts with titled story arcs or series."
            }
          ]
        },
        "priority": {
          "type": "integer",
          "default": 0,
          "description": "Sort priority among sibling playlists."
        },
        "contentType": {
          "type": "string",
          "enum": [
            "episodes",
            "groups"
          ],
          "description": "Content type: \"episodes\" for flat lists, \"groups\" for grouped display."
        },
        "yearHeaderMode": {
          "type": "string",
          "enum": [
            "firstEpisode",
            "lastEpisode",
            "publishYear"
          ],
          "description": "How to determine year for year headers."
        },
        "episodeYearHeaders": {
          "type": "boolean",
          "default": false,
          "description": "Whether to show year headers within episode lists."
        },
        "showDateRange": {
          "type": "boolean",
          "default": false,
          "description": "Whether group cards display a date range."
        },
        "titleFilter": {
          "type": "string",
          "description": "Regex pattern to filter episode titles (include)."
        },
        "excludeFilter": {
          "type": "string",
          "description": "Regex pattern to exclude episodes by title."
        },
        "requireFilter": {
          "type": "string",
          "description": "Regex pattern that episodes must match."
        },
        "nullSeasonGroupKey": {
          "type": "integer",
          "description": "Group key assigned to episodes with null season."
        },
        "groups": {
          "type": "array",
          "description": "Static group definitions for category-based grouping.",
          "items": {
            "$ref": "#/$defs/SmartPlaylistGroupDef"
          }
        },
        "customSort": {
          "$ref": "#/$defs/SmartPlaylistSortSpec",
          "description": "Custom sort specification for this playlist."
        },
        "titleExtractor": {
          "$ref": "#/$defs/SmartPlaylistTitleExtractor",
          "description": "Configuration for extracting playlist display names from episode data."
        },
        "episodeNumberExtractor": {
          "$ref": "#/$defs/EpisodeNumberExtractor",
          "description": "Configuration for extracting episode numbers from episode titles."
        },
        "smartPlaylistEpisodeExtractor": {
          "$ref": "#/$defs/SmartPlaylistEpisodeExtractor",
          "description": "Configuration for extracting both season and episode numbers from title prefixes."
        }
      }
    },
    "SmartPlaylistGroupDef": {
      "type": "object",
      "description": "Static group definition. Groups with a pattern match episodes by title regex; without a pattern, acts as catch-all.",
      "required": [
        "id",
        "displayName"
      ],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this group."
        },
        "displayName": {
          "type": "string",
          "description": "Human-readable name for display."
        },
        "pattern": {
          "type": "string",
          "description": "Regex pattern to match episode titles. Null means catch-all fallback."
        },
        "episodeYearHeaders": {
          "type": "boolean",
          "description": "Per-group override for episode year headers. Inherits from playlist when null."
        },
        "showDateRange": {
          "type": "boolean",
          "description": "Per-group override for date range display. Inherits from playlist when null."
        }
      }
    },
    "SmartPlaylistSortSpec": {
      "type": "object",
      "description": "Sort specification, either simple (single-field) or composite (multi-rule).",
      "required": [
        "type"
      ],
      "oneOf": [
        {
          "type": "object",
          "description": "Simple single-field sort.",
          "required": [
            "type",
            "field",
            "order"
          ],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "const": "simple"
            },
            "field": {
              "type": "string",
              "enum": [
                "playlistNumber",
                "newestEpisodeDate",
                "progress",
                "alphabetical"
              ],
              "description": "Field to sort by."
            },
            "order": {
              "type": "string",
              "enum": [
                "ascending",
                "descending"
              ],
              "description": "Sort direction."
            }
          }
        },
        {
          "type": "object",
          "description": "Composite sort with multiple rules.",
          "required": [
            "type",
            "rules"
          ],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "const": "composite"
            },
            "rules": {
              "type": "array",
              "description": "Ordered list of sort rules.",
              "items": {
                "$ref": "#/$defs/SmartPlaylistSortRule"
              },
              "minItems": 1
            }
          }
        }
      ]
    },
    "SmartPlaylistSortRule": {
      "type": "object",
      "description": "A single rule in a composite sort.",
      "required": [
        "field",
        "order"
      ],
      "additionalProperties": false,
      "properties": {
        "field": {
          "type": "string",
          "enum": [
            "playlistNumber",
            "newestEpisodeDate",
            "progress",
            "alphabetical"
          ],
          "description": "Field to sort by."
        },
        "order": {
          "type": "string",
          "enum": [
            "ascending",
            "descending"
          ],
          "description": "Sort direction."
        },
        "condition": {
          "$ref": "#/$defs/SmartPlaylistSortCondition",
          "description": "Optional condition for when this rule applies."
        }
      }
    },
    "SmartPlaylistSortCondition": {
      "type": "object",
      "description": "Condition for conditional sort rules.",
      "required": [
        "type",
        "value"
      ],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "sortKeyGreaterThan",
            "greaterThan"
          ],
          "description": "Condition type. \"sortKeyGreaterThan\" applies when the sort key exceeds the given value."
        },
        "value": {
          "type": "integer",
          "description": "Threshold value for the condition."
        }
      }
    },
    "SmartPlaylistTitleExtractor": {
      "type": "object",
      "description": "Extracts playlist display names from episode data using source field, regex, and templates.",
      "required": [
        "source"
      ],
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "enum": [
            "title",
            "description",
            "seasonNumber",
            "episodeNumber"
          ],
          "description": "Episode field to extract from."
        },
        "pattern": {
          "type": "string",
          "description": "Regex pattern to extract value from the source."
        },
        "group": {
          "type": "integer",
          "default": 0,
          "description": "Capture group index from regex match (0 = full match)."
        },
        "template": {
          "type": "string",
          "description": "Template with {value} placeholder for formatting."
        },
        "fallback": {
          "$ref": "#/$defs/SmartPlaylistTitleExtractor",
          "description": "Fallback extractor when this one fails."
        },
        "fallbackValue": {
          "type": "string",
          "description": "Fallback string for null/zero seasonNumber."
        }
      }
    },
    "EpisodeNumberExtractor": {
      "type": "object",
      "description": "Extracts episode-in-season number from episode titles using regex.",
      "required": [
        "pattern"
      ],
      "additionalProperties": false,
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Regex pattern to extract episode number."
        },
        "captureGroup": {
          "type": "integer",
          "default": 1,
          "description": "Capture group index for the episode number."
        },
        "fallbackToRss": {
          "type": "boolean",
          "default": true,
          "description": "Whether to fall back to RSS episodeNumber on regex failure."
        }
      }
    },
    "SmartPlaylistEpisodeExtractor": {
      "type": "object",
      "description": "Extracts both season and episode numbers from episode title prefixes. Useful for podcasts with unreliable RSS metadata.",
      "required": [
        "source",
        "pattern"
      ],
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "enum": [
            "title",
            "description"
          ],
          "description": "Episode field to extract from."
        },
        "pattern": {
          "type": "string",
          "description": "Primary regex to extract both season and episode numbers."
        },
        "seasonGroup": {
          "type": "integer",
          "default": 1,
          "description": "Capture group index for season number."
        },
        "episodeGroup": {
          "type": "integer",
          "default": 2,
          "description": "Capture group index for episode number."
        },
        "fallbackSeasonNumber": {
          "type": "integer",
          "description": "Season number when primary pattern fails but fallback matches."
        },
        "fallbackEpisodePattern": {
          "type": "string",
          "description": "Fallback regex for special episodes."
        },
        "fallbackEpisodeCaptureGroup": {
          "type": "integer",
          "default": 1,
          "description": "Capture group for episode number in fallback."
        }
      }
    }
  }
}
